name: Scheduled Discord Notification

on:
  # ✅ 設定排程：台灣時間平日晚上 18:00
  # GitHub Actions 使用 UTC 時間，台灣是 UTC+8
  # 18:00 (TW) - 8小時 = 10:00 (UTC)
  schedule:
    - cron: '0 10 * * 1-5'  # 分 時 日 月 週(1=週一)

  # ✅ 保留手動觸發按鈕 (方便你隨時測試)
  workflow_dispatch:

jobs:
  run-notification:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install gspread google-auth requests

    # 產生金鑰 (因為要讀 Sheet)
    - name: Create Service Key
      env:
        GCP_SERVICE_KEY: ${{ secrets.GCP_SERVICE_KEY }}
      run: |
        python - <<'PY'
        import os
        with open("service_key.json", "w", encoding="utf-8") as f:
            f.write(os.environ["GCP_SERVICE_KEY"])
        PY

    # 執行推播程式
    - name: Run Discord Notification
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        # 確保程式能讀到剛剛產生的金鑰
        GOOGLE_APPLICATION_CREDENTIALS: service_key.json
      run: |
        python notify_discord.py

    - name: Cleanup Service Key
      if: always()
      run: rm -f service_key.json
