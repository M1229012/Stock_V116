name: Daily Discord Notification (Weekdays) # 建議改個名字，比較像正式版

on:
  schedule:
    # 說明：分 時 日 月 星期 (1-5 代表週一到週五)
    # 台灣時間 19:00 = UTC 11:00
    - cron: '00 11 * * 1-5'
   
  workflow_dispatch:              # 保留手動執行的按鈕，方便測試

jobs:
  daily-notification:             # job ID 也可以改個比較正式的名字
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install gspread google-auth requests

    # 產生金鑰
    - name: Create Service Key
      env:
        GCP_SERVICE_KEY: ${{ secrets.GCP_SERVICE_KEY }}
      run: |
        python - <<'PY'
        import os
        with open("service_key.json", "w", encoding="utf-8") as f:
            f.write(os.environ["GCP_SERVICE_KEY"])
        PY

    # 執行推播
    - name: Run Discord Notification
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        GOOGLE_APPLICATION_CREDENTIALS: service_key.json
      run: |
        python notify_discord.py

    - name: Cleanup Service Key
      if: always()
      run: rm -f service_key.json
