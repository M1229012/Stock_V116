name: Daily Stock Update (Web Deploy)

# ✅ 並發控制：避免同時跑兩個 Job 導致寫入衝突
concurrency:
  group: daily-stock-update
  cancel-in-progress: false

# ✅ 安全性：設定 GITHUB_TOKEN 的最小權限
permissions:
  contents: read

on:
  push:                  # ✅ 新增這段：只要推送到 main 分支就立即執行
    branches: [ "main" ] # (如果你的分支叫 master，請改成 master)
   
  schedule:
    # ---------------------------------------------------------
    # GitHub Actions 使用 UTC 時間 (台灣時間 -8 小時)
    # ---------------------------------------------------------
   
    # 第 1 跑：台灣 17:30 (UTC 09:30)
    # 目的：抓取收盤後的處置公告、計算基本技術指標 (不含當沖)
    - cron: '30 9 * * 1-5'
   
    # 第 2 跑：台灣 21:15 (UTC 13:15)
    # 目的：補抓 21:00 公布的當沖數據，更新完整報表
    - cron: '15 13 * * 1-5'

    # ✅ 第 3 跑 (保險)：台灣 22:15 (UTC 14:15)
    # 目的：檢查前一次是否成功，若資料不全 (如 TPEx 延遲) 則自動補齊
    - cron: '15 14 * * 1-5'

  workflow_dispatch: # 允許手動按按鈕測試

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ✅ 優化: 升級至 v4
    - name: Checkout code
      uses: actions/checkout@v4

    # ✅ 優化: 升級至 v5 並啟用 pip cache
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install playwright nest_asyncio

    # ✅ 新增: 安裝 Playwright 瀏覽器核心 (必須)
    - name: Install Playwright Browsers
      run: |
        playwright install chromium
        playwright install-deps

    # ✅ 關鍵修正: 改用 Python 寫檔，完美解決 YAML 縮排與 EOF 問題
    - name: Create Service Key
      env:
        GCP_SERVICE_KEY: ${{ secrets.GCP_SERVICE_KEY }}
      run: |
        python - <<'PY'
        import os
        # 將環境變數中的 JSON 金鑰寫入檔案
        with open("service_key.json", "w", encoding="utf-8") as f:
            f.write(os.environ["GCP_SERVICE_KEY"])
        PY

    - name: Run Crawler
      env:
        FinMind_1: ${{ secrets.FinMind_1 }}
        FinMind_2: ${{ secrets.FinMind_2 }}
        RUN_MODE: scheduled 
        TZ: Asia/Taipei
        # ✅ 優化: 宣告標準 Google 憑證路徑
        GOOGLE_APPLICATION_CREDENTIALS: service_key.json
      run: |
        python main.py

    # ✅ 優化: 執行後強制清理敏感檔案
    - name: Cleanup Service Key
      if: always()
      run: rm -f service_key.json
