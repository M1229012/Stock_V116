name: ğŸ§ª æ¸¬è©¦æ¨æ’­ (æ‰‹å‹•/æ›´æ–°è§¸ç™¼)

on:
  push:
    branches:
      - main
    paths:
      - 'notify_discord.py'  # åªæœ‰æ”¹ç¨‹å¼ç¢¼æ‰è§¸ç™¼æ¸¬è©¦
  workflow_dispatch:        # è®“ä½ å¯ä»¥æ‰‹å‹•æŒ‰æŒ‰éˆ•æ¸¬è©¦

jobs:
  test-notification:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # ğŸ“Œ ä¿®æ­£ï¼šé€™è£¡è£œä¸Šäº† yfinanceï¼Œç¢ºä¿æ©Ÿå™¨äººæœ‰å®‰è£é€™å€‹å¥—ä»¶
        pip install gspread google-auth requests yfinance selenium webdriver_manager lxml

    - name: Create Service Key
      env:
        GCP_SERVICE_KEY: ${{ secrets.GCP_SERVICE_KEY }}
      run: |
        python - <<'PY'
        import os
        with open("service_key.json", "w", encoding="utf-8") as f:
            f.write(os.environ["GCP_SERVICE_KEY"])
        PY

    - name: Run Discord Notification (Test Mode)
      env:
        # æ³¨æ„ï¼šé€™è£¡æ”¹æˆè®€å–æ¸¬è©¦ç”¨çš„ Webhook Secret
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL_TEST }}
        GOOGLE_APPLICATION_CREDENTIALS: service_key.json
      run: |
        python notify_discord.py

    - name: Cleanup Service Key
      if: always()
      run: rm -f service_key.json
